# 技術調査レポート: clap

| 項目 | 内容 |
|------|------|
| 調査日 | 2026-01-03 |
| 調査深度 | standard |
| 対象バージョン | v4.5.54 |
| 現行バージョン | 新規導入 |

## エグゼクティブサマリー

`clap` はRustにおける標準的なCLI引数パーサーである。最新のv4系ではパフォーマンスが大幅に向上（v3比で48%高速化）し、バイナリサイズも削減されている。`derive` マクロを使用した宣言的な定義が推奨されており、ポモドーロタイマーのようなサブコマンド（start, stop, pause, resume）を持つツールの実装に最適である。

## バージョン情報

| バージョン | リリース日 | サポート状況 |
|-----------|-----------|-------------|
| v4.5.54 | 2026-01-03 | Active |
| v4.0.0 | 2022-09-00 | Major release |

## Breaking Changes (v3 -> v4)

### 🚨 高影響

| 変更内容 | 影響範囲 | 移行方法 |
|---------|---------|---------|
| アトリビュート名の変更 | `derive` マクロ使用コード | `#[clap(...)]` を `#[command(...)]` (コマンド用), `#[arg(...)]` (引数用), `#[value(...)]` (列挙型用) に置き換える。 |
| `validator` 等の削除 | バリデーション処理 | `value_parser!` マクロまたはカスタム `ValueParser` を使用する。 |

## 新機能・改善点

| 機能 | 概要 | 活用シーン |
|------|------|----------|
| `ArgAction` | 引数の動作（Set, SetTrue, Count等）を明示化 | フラグやカウント引数の実装簡略化 |
| パフォーマンス改善 | 起動時間とメモリ使用量の削減 | インタラクティブなCLIツールのDX向上 |
| `num_args` API | 期待する引数の数を一元管理 | 可変引数やオプション引数の柔軟な定義 |

## 設計への影響

### 必須対応

- [ ] `features = ["derive"]` を有効にする。
- [ ] サブコマンドは `enum` で定義し、各サブコマンドに固有の引数がある場合は別の `struct` に分ける（`flatten` も活用）。

### 推奨対応

- [ ] `propagate_version = true` を設定し、サブコマンドでも親のバージョン情報を継承する。
- [ ] `help` メッセージを `///` (doc comment) で記述し、自動生成されるヘルプを充実させる。

## マイグレーション手順（該当時）

新規導入：

```bash
cargo add clap --features derive
```

## 参考リンク

- [公式ドキュメント](https://docs.rs/clap/latest/clap/)
- [clap v4 Migration Guide](https://epage.github.io/blog/2022/09/clap4/)
- [Examples](https://github.com/clap-rs/clap/tree/master/examples)
