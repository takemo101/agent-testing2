# ポモドーロタイマーCLI 要件定義書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | REQ-CLI-001 |
| バージョン | 2.1.0 |
| ステータス | ドラフト |
| 作成日 | 2026-01-03 |
| 最終更新日 | 2026-01-03 |
| 作成者 | - |
| 承認者 | - |

---

## 1. プロジェクト概要

### 1.1 背景

現代の知識労働者、特に開発者やエンジニアは、長時間の集中作業による疲労や、SNS・通知による中断により、生産性の低下に悩まされています。ポモドーロテクニックは、25分の集中作業と5分の休憩を繰り返すことで、集中力を維持しながら効率的に作業を進める時間管理手法として広く知られています。

しかし、既存のポモドーロタイマーツールは以下の課題があります：

- **GUI依存**: デスクトップアプリケーションが多く、ターミナル作業中に画面を切り替える必要がある
- **複雑な機能**: 不要な機能が多く、シンプルに使いたいユーザーには過剰
- **macOS機能の未活用**: メニューバーやフォーカスモードなど、macOSの強力な機能を活用していない

これらの課題を解決するため、**macOS専用**でターミナル上で完結し、かつmacOSのネイティブ機能をフル活用するシンプルなポモドーロタイマーCLIツールを開発します。macOS専用とすることで、Notification Center、メニューバー常駐、フォーカスモード連携など、macOSの強力な機能を最大限に活用できます。

### 1.2 目的

本プロジェクトの目的は以下の通りです：

1. **ターミナルワークフローの中断を最小化**: CLI上で完結することで、開発者の作業フローを妨げない
2. **シンプルで直感的な操作性**: 複雑な設定なしに、すぐに使い始められる
3. **macOSネイティブ機能の最大活用**: Notification Center、メニューバー、フォーカスモードなど、macOS固有の機能を統合
4. **個人の生産性向上**: ポモドーロテクニックの実践を支援し、集中力と作業効率を向上させる

### 1.3 ゴール

本プロジェクトの成功指標は以下の通りです：

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| 初回起動から使用開始までの時間 | 1分以内 | ユーザーテスト |
| macOS対応バージョン | macOS 12 (Monterey) 以降 | CI/CDでの動作確認 |
| バイナリサイズ | 10MB以下 | リリースビルドの測定 |
| 起動時間 | 1秒以内 | ベンチマーク測定 |
| コマンド実行成功率 | 99%以上 | エラーログ分析 |
| メニューバー表示遅延 | 0.5秒以内 | 手動テスト |

### 1.4 スコープ

#### 対象範囲

- ポモドーロタイマーの基本機能（作業・休憩サイクル）
- macOS Notification Centerによるタイマー完了通知（アクションボタン付き）
- ターミナル上でのタイマー制御（開始・停止・一時停止・再開）
- メニューバー常駐による残り時間表示とクイック操作
- macOSフォーカスモード連携（作業中ON、休憩中OFF）
- LaunchAgentによるログイン時自動起動・バックグラウンド実行
- 残り時間のリアルタイム表示
- 時間のカスタマイズ機能
- タスク名の設定機能
- 自動サイクル機能
- macOSネイティブサウンドによる通知音

#### 対象外（Phase 2以降で検討）

- 統計・履歴記録機能
- レポート出力機能
- 設定ファイルによる永続化
- 時間追加機能
- カラー/スタイルカスタマイズ
- ショートカットApp連携
- Spotlight連携

---

## 2. ステークホルダー

### 2.1 ステークホルダー一覧

| 役割 | 担当者/部門 | 関心事 | 影響度 |
|------|------------|--------|--------|
| プロダクトオーナー | takemo101 | プロジェクトの成功、品質 | 高 |
| 開発者 | takemo101 | 技術選定、実装品質 | 高 |
| エンドユーザー | 開発者・エンジニア | 使いやすさ、生産性向上 | 高 |
| OSSコミュニティ | GitHub利用者 | コードの品質、ドキュメント | 中 |

### 2.2 ユーザーペルソナ

#### ペルソナ1: ターミナル常駐開発者

| 項目 | 内容 |
|------|------|
| 名前 | 田中太郎（仮名） |
| 属性 | 28歳、バックエンドエンジニア、在宅勤務 |
| 技術スタック | Rust, Go, Python, Vim/Neovim |
| 課題 | 長時間のコーディングで集中力が低下、休憩を取るタイミングを忘れる |
| ニーズ | ターミナルから離れずに使えるタイマー、シンプルな操作 |
| 利用シーン | コーディング中、ターミナルのタブで常時起動 |
| 期待する価値 | 作業フローを中断せずに時間管理ができる |

#### ペルソナ2: マルチタスク在宅ワーカー

| 項目 | 内容 |
|------|------|
| 名前 | 佐藤花子（仮名） |
| 属性 | 35歳、フリーランスエンジニア、複数プロジェクト兼務 |
| 技術スタック | JavaScript, TypeScript, React, VSCode |
| 課題 | 複数タスクの切り替えで集中力が散漫、時間管理が苦手 |
| ニーズ | タスクごとに時間を計測、通知で次のタスクへの切り替えを促してほしい |
| 利用シーン | プロジェクトごとにタスク名を設定して作業 |
| 期待する価値 | タスクの可視化と、メリハリのある作業リズム |

#### ペルソナ3: macOSパワーユーザー

| 項目 | 内容 |
|------|------|
| 名前 | 鈴木一郎（仮名） |
| 属性 | 32歳、フルスタックエンジニア、MacBook Pro (M2) 使用 |
| 技術スタック | Rust, TypeScript, React, Neovim |
| 課題 | 作業中の通知が多く集中できない、macOSの機能を活用したい |
| ニーズ | フォーカスモード自動制御、メニューバーから素早く操作したい |
| 利用シーン | コーディング中、複数のプロジェクトを並行作業 |
| 期待する価値 | macOSとシームレスに統合された、邪魔にならないツール |

---

## 3. 機能要件

### 3.1 機能一覧

| ID | 機能名 | 概要 | 優先度 | フェーズ |
|----|--------|------|--------|---------|
| F-001 | 基本タイマー機能 | 25分作業・5分休憩のサイクル実行 | 必須 | Phase 1 |
| F-002 | システム通知 | タイマー完了時のデスクトップ通知 | 必須 | Phase 1 |
| F-003 | タイマー制御 | start/pause/resume/stop操作 | 必須 | Phase 1 |
| F-004 | 残り時間表示 | プログレスバー/カウントダウン表示 | 必須 | Phase 1 |
| F-005 | 長い休憩 | 4ポモドーロ後に15-30分の長い休憩 | 必須 | Phase 1 |
| F-006 | 時間カスタマイズ | 作業時間・休憩時間の変更 | 重要 | Phase 1 |
| F-007 | タスク名設定 | 現在のポモドーロのタスク名設定 | 重要 | Phase 1 |
| F-008 | ステータス確認 | 現在のタイマー状態の確認 | 重要 | Phase 1 |
| F-009 | 自動サイクル | 休憩後の自動作業開始 | 重要 | Phase 1 |
| F-010 | 統計・履歴記録 | 完了ポモドーロ数の記録 | あれば良い | Phase 2 |
| F-011 | レポート出力 | 統計データのJSON/CSV出力 | あれば良い | Phase 2 |
| F-012 | 設定ファイル | デフォルト設定の永続化 | あれば良い | Phase 2 |
| F-013 | 時間追加機能 | 実行中タイマーへの時間追加 | あれば良い | Phase 2 |
| F-014 | カラー/スタイル設定 | 表示のカスタマイズ | あれば良い | Phase 2 |
| F-017 | ネイティブ通知拡張 | アクションボタン付き通知（一時停止/停止） | 必須 | Phase 1 |
| F-018 | メニューバー常駐 | メニューバーアイコンで残り時間表示とクイック操作 | 重要 | Phase 1 |
| F-019 | フォーカスモード連携 | 作業中に自動でフォーカスモードON、休憩中にOFF | 重要 | Phase 1 |
| F-020 | LaunchAgent | ログイン時自動起動、バックグラウンド実行 | 必須 | Phase 1 |
| F-021 | システムサウンド | macOSネイティブサウンドで通知音 | あれば良い | Phase 1 |
| F-022 | ショートカットApp連携 | Shortcuts.appからの操作対応 | あれば良い | Phase 2 |
| F-023 | Spotlight連携 | Spotlightからのクイック操作 | あれば良い | Phase 2 |

### 3.2 ユーザーストーリー

#### US-001: 基本的なポモドーロタイマーの実行

- **ユーザー**: ターミナル常駐開発者
- **したいこと**: コマンド一つでポモドーロタイマーを開始したい
- **理由**: 複雑な操作なしに、すぐに集中作業を始めたい
- **受け入れ基準**:
  - [ ] `pomodoro start` コマンドで25分タイマーが開始される
  - [ ] ターミナル上に残り時間が表示される
  - [ ] 25分経過後、システム通知が表示される
  - [ ] 自動的に5分の休憩タイマーに切り替わる
- **関連機能**: F-001, F-002, F-004

#### US-002: タイマーの一時停止と再開

- **ユーザー**: マルチタスク在宅ワーカー
- **したいこと**: 急な電話や会議で作業を中断する際、タイマーを一時停止したい
- **理由**: 中断時間を作業時間に含めたくない
- **受け入れ基準**:
  - [ ] `pomodoro pause` コマンドでタイマーが一時停止する
  - [ ] `pomodoro resume` コマンドで残り時間から再開する
  - [ ] 一時停止中は残り時間が固定表示される
- **関連機能**: F-003

#### US-003: カスタム時間でのタイマー実行

- **ユーザー**: Linux愛好家
- **したいこと**: 自分の集中力に合わせて作業時間を調整したい
- **理由**: 25分では短すぎる/長すぎる場合がある
- **受け入れ基準**:
  - [ ] `pomodoro start --work 30 --break 10` で30分作業・10分休憩に設定できる
  - [ ] 設定した時間でタイマーが動作する
  - [ ] ヘルプに時間指定の方法が記載されている
- **関連機能**: F-006

#### US-004: タスク名の設定と確認

- **ユーザー**: マルチタスク在宅ワーカー
- **したいこと**: 今何の作業をしているか記録したい
- **理由**: 複数プロジェクトを並行しており、後で振り返りたい
- **受け入れ基準**:
  - [ ] `pomodoro start --task "API実装"` でタスク名を設定できる
  - [ ] `pomodoro status` で現在のタスク名が表示される
  - [ ] タイマー完了通知にタスク名が含まれる
- **関連機能**: F-007, F-008

#### US-005: 長い休憩の自動実行

- **ユーザー**: ターミナル常駐開発者
- **したいこと**: 4ポモドーロ完了後、自動的に長い休憩に入りたい
- **理由**: ポモドーロテクニックの推奨サイクルに従いたい
- **受け入れ基準**:
  - [ ] 4回目のポモドーロ完了後、15分の長い休憩が開始される
  - [ ] 長い休憩時間は `--long-break` オプションで変更可能
  - [ ] 通知に「長い休憩」であることが明示される
- **関連機能**: F-005

#### US-006: タイマー状態の確認

- **ユーザー**: Linux愛好家
- **したいこと**: 別のターミナルから現在のタイマー状態を確認したい
- **理由**: tmuxで複数ペインを使用しており、タイマーペインが見えないことがある
- **受け入れ基準**:
  - [ ] `pomodoro status` で現在の状態（作業中/休憩中/停止中）が表示される
  - [ ] 残り時間、現在のポモドーロ回数が表示される
  - [ ] タスク名が設定されている場合は表示される
- **関連機能**: F-008

#### US-007: 自動サイクルの実行

- **ユーザー**: ターミナル常駐開発者
- **したいこと**: 休憩終了後、自動的に次の作業タイマーを開始したい
- **理由**: 手動で再開するのを忘れてしまう
- **受け入れ基準**:
  - [ ] `pomodoro start --auto-cycle` で自動サイクルが有効になる
  - [ ] 休憩終了後、自動的に次の作業タイマーが開始される
  - [ ] 自動開始時に通知が表示される
- **関連機能**: F-009

#### US-008: メニューバーからのクイック操作

- **ユーザー**: macOSパワーユーザー
- **したいこと**: メニューバーから素早くタイマーを操作したい
- **理由**: ターミナルを開かずに操作したい
- **受け入れ基準**:
  - [ ] メニューバーに残り時間が表示される
  - [ ] メニューバーアイコンをクリックすると操作メニューが表示される
  - [ ] メニューから一時停止・停止が実行できる
  - [ ] 現在のタスク名と状態が確認できる
- **関連機能**: F-018

#### US-009: フォーカスモード自動制御

- **ユーザー**: macOSパワーユーザー
- **したいこと**: 作業中は自動的にフォーカスモードをONにして通知を遮断したい
- **理由**: 集中作業中に通知で邪魔されたくない
- **受け入れ基準**:
  - [ ] `pomodoro start --focus-mode` でフォーカスモード連携が有効になる
  - [ ] 作業タイマー開始時に自動的にフォーカスモードがONになる
  - [ ] 休憩タイマー開始時に自動的にフォーカスモードがOFFになる
  - [ ] フォーカスモードの変更が通知される
- **関連機能**: F-019

#### US-010: ログイン時自動起動

- **ユーザー**: ターミナル常駐開発者
- **したいこと**: macOSログイン時に自動的にタイマーをバックグラウンドで起動したい
- **理由**: 毎回手動で起動するのが面倒
- **受け入れ基準**:
  - [ ] `pomodoro install` でLaunchAgentがインストールされる
  - [ ] ログイン時に自動的にバックグラウンドで起動する
  - [ ] メニューバーアイコンが表示される
  - [ ] `pomodoro uninstall` でLaunchAgentが削除される
- **関連機能**: F-020

#### US-011: 通知からの直接操作

- **ユーザー**: マルチタスク在宅ワーカー
- **したいこと**: タイマー完了通知から直接一時停止や停止をしたい
- **理由**: ターミナルやメニューバーを開くのが面倒
- **受け入れ基準**:
  - [ ] タイマー完了通知に「一時停止」「停止」ボタンが表示される
  - [ ] ボタンをクリックすると対応する操作が実行される
  - [ ] 操作結果が新しい通知で表示される
- **関連機能**: F-017

### 3.3 機能詳細

#### F-001: 基本タイマー機能

**概要**: ポモドーロテクニックの基本サイクル（25分作業・5分休憩）を実行する

**入力**:
- コマンド: `pomodoro start`
- オプション: なし（デフォルト値使用）

**出力**:
- ターミナル上にタイマー開始メッセージ
- 残り時間のリアルタイム表示
- タイマー完了時のシステム通知

**処理概要**:
1. タイマーを25分（1500秒）に設定
2. 1秒ごとに残り時間を更新して表示
3. 0秒になったらシステム通知を送信
4. 自動的に5分（300秒）の休憩タイマーに切り替え
5. 休憩終了後、通知を送信して停止

**ビジネスルール**:
- BR-001: デフォルト作業時間は25分とする
- BR-002: デフォルト短い休憩時間は5分とする
- BR-003: タイマーはバックグラウンドで動作し、ターミナルを閉じても継続する

**制約事項**:
- 同時に複数のタイマーは起動できない
- タイマー実行中は新しいタイマーを開始できない

---

#### F-002: システム通知

**概要**: タイマー完了時にデスクトップ通知を表示する

**入力**:
- タイマー完了イベント
- タスク名（設定されている場合）

**出力**:
- デスクトップ通知（タイトル、メッセージ、アイコン）

**処理概要**:
1. タイマー完了を検知
2. 通知内容を構築（作業完了/休憩完了）
3. OSのネイティブ通知APIを使用して通知を表示
4. タスク名が設定されている場合は通知に含める

**ビジネスルール**:
- BR-004: 通知タイトルは「ポモドーロタイマー」とする
- BR-005: 作業完了時は「作業時間が終了しました。休憩してください。」
- BR-006: 休憩完了時は「休憩時間が終了しました。作業を再開してください。」
- BR-007: タスク名がある場合は「[タスク名] 作業時間が終了しました」

**制約事項**:
- 通知機能はOSに依存する（macOS/Windows/Linuxで動作確認必須）
- 通知が表示されない環境でもエラーにしない（警告ログのみ）

---

#### F-003: タイマー制御

**概要**: タイマーの開始・停止・一時停止・再開を制御する

**入力**:
- `pomodoro start`: タイマー開始
- `pomodoro pause`: タイマー一時停止
- `pomodoro resume`: タイマー再開
- `pomodoro stop`: タイマー停止

**出力**:
- 各操作の成功/失敗メッセージ
- 現在の状態表示

**処理概要**:
1. **start**: 新しいタイマーを開始（既存タイマーがある場合はエラー）
2. **pause**: 実行中のタイマーを一時停止（残り時間を保存）
3. **resume**: 一時停止中のタイマーを再開（保存された残り時間から継続）
4. **stop**: タイマーを完全に停止（状態をクリア）

**ビジネスルール**:
- BR-008: 一時停止中のタイマーは `resume` でのみ再開可能
- BR-009: `stop` 実行後は状態がリセットされ、新しい `start` が必要
- BR-010: 休憩中も `pause`/`resume`/`stop` が可能

**制約事項**:
- タイマーが実行されていない状態で `pause`/`resume` はエラー
- 一時停止していない状態で `resume` はエラー

---

#### F-004: 残り時間表示

**概要**: ターミナル上にタイマーの残り時間をリアルタイムで表示する

**入力**:
- 現在の残り時間（秒）
- タイマーの種類（作業/短い休憩/長い休憩）

**出力**:
- プログレスバー
- 残り時間（MM:SS形式）
- 現在のポモドーロ回数

**処理概要**:
1. 1秒ごとに画面を更新
2. プログレスバーで進捗を視覚化
3. 残り時間を分:秒形式で表示
4. 現在何回目のポモドーロかを表示

**表示例**:
```
🍅 ポモドーロ #1 - 作業中
[████████████████░░░░] 15:30 / 25:00
タスク: API実装
```

**ビジネスルール**:
- BR-011: プログレスバーは20文字で表示
- BR-012: 作業中は🍅、休憩中は☕を表示
- BR-013: 1秒ごとに更新（ちらつき防止のため同じ行を上書き）

**制約事項**:
- ターミナルの幅が狭い場合は表示が崩れる可能性がある
- ANSIエスケープシーケンスに対応していないターミナルでは正しく表示されない

---

#### F-005: 長い休憩

**概要**: 4ポモドーロ完了後に15-30分の長い休憩を実行する

**入力**:
- 完了したポモドーロ回数
- 長い休憩時間（デフォルト15分、オプションで変更可能）

**出力**:
- 長い休憩開始の通知
- 長い休憩タイマーの表示

**処理概要**:
1. ポモドーロ完了回数をカウント
2. 4回目の完了時、長い休憩フラグを設定
3. 通常の休憩の代わりに長い休憩タイマーを開始
4. 長い休憩完了後、カウントをリセット

**ビジネスルール**:
- BR-014: デフォルトの長い休憩時間は15分とする
- BR-015: 4ポモドーロごとに長い休憩を挟む
- BR-016: 長い休憩後、ポモドーロカウントは1にリセット

**制約事項**:
- 長い休憩中に `stop` した場合、カウントはリセットされる

---

#### F-006: 時間カスタマイズ

**概要**: 作業時間・休憩時間をコマンドラインオプションで変更可能にする

**入力**:
- `--work <分>`: 作業時間（デフォルト25分）
- `--break <分>`: 短い休憩時間（デフォルト5分）
- `--long-break <分>`: 長い休憩時間（デフォルト15分）

**出力**:
- 設定された時間でタイマーが動作

**処理概要**:
1. コマンドライン引数をパース
2. 指定された時間を検証（1-120分の範囲）
3. 検証OKなら指定時間でタイマーを開始
4. 検証NGならエラーメッセージを表示

**使用例**:
```bash
# 30分作業、10分休憩
pomodoro start --work 30 --break 10

# 長い休憩を30分に設定
pomodoro start --long-break 30
```

**ビジネスルール**:
- BR-017: 作業時間は1-120分の範囲で指定可能
- BR-018: 休憩時間は1-60分の範囲で指定可能
- BR-019: 範囲外の値はエラーとする

**制約事項**:
- 時間指定は整数のみ（小数点不可）
- 負の値は受け付けない

---

#### F-007: タスク名設定

**概要**: 現在のポモドーロに取り組むタスク名を設定する

**入力**:
- `--task <タスク名>`: タスク名（文字列）

**出力**:
- タイマー表示にタスク名を含める
- 通知にタスク名を含める

**処理概要**:
1. コマンドライン引数からタスク名を取得
2. タイマー状態にタスク名を保存
3. 表示・通知時にタスク名を使用

**使用例**:
```bash
pomodoro start --task "API実装"
```

**ビジネスルール**:
- BR-020: タスク名は最大100文字まで
- BR-021: タスク名が未設定の場合は表示しない
- BR-022: タスク名は通知のタイトルまたは本文に含める

**制約事項**:
- 特殊文字（改行、タブ等）は使用不可
- 空文字列は未設定として扱う

---

#### F-008: ステータス確認

**概要**: 現在のタイマー状態を確認する

**入力**:
- `pomodoro status`: ステータス確認コマンド

**出力**:
- 現在の状態（作業中/休憩中/一時停止中/停止中）
- 残り時間
- 現在のポモドーロ回数
- タスク名（設定されている場合）

**処理概要**:
1. タイマーの現在状態を取得
2. フォーマットして表示

**表示例**:
```
ステータス: 作業中
残り時間: 15:30
ポモドーロ: #2
タスク: API実装
```

**ビジネスルール**:
- BR-023: タイマーが停止中の場合は「停止中」と表示
- BR-024: 一時停止中の場合は残り時間も表示

**制約事項**:
- タイマーが起動していない場合は「タイマーは起動していません」と表示

---

#### F-009: 自動サイクル

**概要**: 休憩終了後、自動的に次の作業タイマーを開始する

**入力**:
- `--auto-cycle`: 自動サイクルフラグ

**出力**:
- 休憩終了後、自動的に作業タイマーが開始される
- 自動開始時に通知が表示される

**処理概要**:
1. 休憩タイマー完了を検知
2. 自動サイクルフラグがONの場合、次の作業タイマーを自動開始
3. 自動開始時に通知を送信

**使用例**:
```bash
pomodoro start --auto-cycle
```

**ビジネスルール**:
- BR-025: 自動サイクルはデフォルトOFF
- BR-026: 長い休憩後も自動サイクルが有効な場合は作業を開始
- BR-027: 自動開始時は「作業を自動開始しました」と通知

**制約事項**:
- `stop` コマンドで明示的に停止するまで継続
- 一時停止中は自動サイクルは動作しない

---

#### F-017: ネイティブ通知拡張

**概要**: macOS Notification Centerでアクションボタン付き通知を表示する

**入力**:
- タイマー完了イベント
- タスク名（設定されている場合）

**出力**:
- アクションボタン付きデスクトップ通知（一時停止/停止ボタン）

**処理概要**:
1. タイマー完了を検知
2. UserNotifications frameworkを使用して通知を構築
3. アクションボタン（「一時停止」「停止」）を追加
4. 通知をNotification Centerに送信
5. ユーザーのアクション（ボタンクリック）を受け取り、対応する処理を実行

**ビジネスルール**:
- BR-043: 通知には「一時停止」「停止」の2つのアクションボタンを含める
- BR-044: 通知クリック時はステータス表示を行う
- BR-045: 通知は通知センターに履歴として残る

**制約事項**:
- macOS 10.14 (Mojave) 以降で動作
- 通知許可が必要（初回起動時に許可を求める）

---

#### F-018: メニューバー常駐

**概要**: メニューバーにアイコンを表示し、残り時間とクイック操作を提供する

**入力**:
- タイマーの現在状態
- 残り時間

**出力**:
- メニューバーアイコン（残り時間表示）
- ドロップダウンメニュー（開始/一時停止/再開/停止）

**処理概要**:
1. AppKitを使用してメニューバーアイテムを作成
2. 1秒ごとに残り時間を更新してアイコンに表示
3. クリック時にドロップダウンメニューを表示
4. メニュー項目選択時に対応するコマンドを実行

**表示例**:
```
メニューバーアイコン: 🍅 15:30

ドロップダウンメニュー:
- ポモドーロタイマー
- ─────────────
- 作業中: API実装
- 残り時間: 15:30
- ポモドーロ: #2
- ─────────────
- ⏸ 一時停止
- ⏹ 停止
- ─────────────
- 設定...
- 終了
```

**ビジネスルール**:
- BR-046: 作業中は🍅、休憩中は☕をアイコンに表示
- BR-047: 停止中はグレーアウトしたアイコンを表示
- BR-048: メニューから直接タイマー操作が可能

**制約事項**:
- メニューバー常駐にはバックグラウンドプロセスが必要
- システムリソースを最小限に抑える（メモリ50MB以下）

---

#### F-019: フォーカスモード連携

**概要**: 作業中に自動でmacOSフォーカスモードをON、休憩中にOFFにする

**入力**:
- タイマーの状態変更イベント（作業開始/休憩開始）

**出力**:
- macOSフォーカスモードの自動ON/OFF

**処理概要**:
1. 作業タイマー開始時、Focus APIを使用してフォーカスモードをON
2. 休憩タイマー開始時、フォーカスモードをOFF
3. ユーザーが手動でフォーカスモードを変更した場合は尊重

**ビジネスルール**:
- BR-049: デフォルトで「仕事」フォーカスモードを使用
- BR-050: フォーカスモード名は設定で変更可能
- BR-051: フォーカスモード連携はオプションで無効化可能

**制約事項**:
- macOS 12 (Monterey) 以降で動作
- フォーカスモードが事前に設定されている必要がある
- システム設定でフォーカスモードの自動化許可が必要
- 公式APIが利用できない場合は、ショートカットApp経由（`/usr/bin/shortcuts run`）で代替実装する
- フォーカスモード制御は「仕事」モードをデフォルトとし、設定で変更可能とする

---

#### F-020: LaunchAgent

**概要**: ログイン時に自動起動し、バックグラウンドで実行する

**入力**:
- LaunchAgent plistファイル

**出力**:
- ログイン時の自動起動
- バックグラウンドでのタイマー実行

**処理概要**:
1. インストール時に `~/Library/LaunchAgents/` にplistファイルを配置
2. `launchctl load` でLaunchAgentを登録
3. ログイン時に自動起動
4. バックグラウンドでタイマーを管理

**plist例**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.example.pomodoro</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/pomodoro</string>
        <string>daemon</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
</dict>
</plist>
```

**ビジネスルール**:
- BR-028: デーモンプロセスはUnix Domain Socket経由でCLIコマンドを受け付ける
- BR-029: CLIはデーモンに接続して状態取得・操作を行う
- BR-030: デーモン未起動時はCLIが自動的にデーモンを起動する
- BR-031: LaunchAgent未登録時、`pomodoro start`はフォアグラウンドモードで動作し、警告を表示する
- BR-032: `pomodoro install`コマンドでLaunchAgentを登録する
- BR-037: `pomodoro install` コマンドでLaunchAgentを登録
- BR-038: `pomodoro uninstall` コマンドでLaunchAgentを削除
- BR-039: バックグラウンドプロセスはCPU使用率1%以下を維持

**制約事項**:
- LaunchAgentの登録には管理者権限は不要
- アンインストール時は必ずLaunchAgentを削除

---

#### F-021: システムサウンド

**概要**: タイマー完了時にmacOSネイティブサウンドで通知音を鳴らす

**入力**:
- タイマー完了イベント

**出力**:
- macOSシステムサウンドの再生

**処理概要**:
1. タイマー完了を検知
2. Core Audioまたはrodioを使用してシステムサウンドを再生
3. デフォルトは「Glass」サウンド

**ビジネスルール**:
- BR-040: デフォルトサウンドは「Glass」
- BR-041: サウンドはオプションで無効化可能
- BR-042: カスタムサウンドファイルの指定も可能（Phase 2）

**制約事項**:
- システムサウンドが無効の場合は再生されない
- 音量はシステム設定に従う

---

## 4. 非機能要件

### 4.1 性能要件

| ID | 要件 | 目標値 | 測定方法 |
|----|------|--------|----------|
| NFR-P-001 | 起動時間 | 1秒以内 | `time` コマンドでの測定 |
| NFR-P-002 | メモリ使用量 | 50MB以下 | プロセスモニタでの測定 |
| NFR-P-003 | CPU使用率 | アイドル時1%以下 | プロセスモニタでの測定 |
| NFR-P-004 | バイナリサイズ | 10MB以下 | リリースビルドのファイルサイズ |
| NFR-P-005 | 通知遅延 | タイマー完了から1秒以内 | 手動テスト |

### 4.2 可用性要件

| ID | 要件 | 目標値 |
|----|------|--------|
| NFR-A-001 | コマンド実行成功率 | 99%以上 |
| NFR-A-002 | クラッシュ発生率 | 0.1%以下 |
| NFR-A-003 | エラーハンドリング | すべてのエラーで適切なメッセージ表示 |

### 4.3 移植性要件

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-PO-001 | 対応OS | macOS 12 (Monterey) 以降（macOS専用） |
| NFR-PO-002 | アーキテクチャ | x86_64（Intel Mac）、ARM64（Apple Silicon: M1/M2/M3） |
| NFR-PO-003 | ターミナル | ANSI対応ターミナル（iTerm2、Terminal.app等） |
| NFR-PO-004 | macOSバージョン | macOS 12以降（フォーカスモード連携のため） |

### 4.4 ユーザビリティ要件

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-U-001 | ヘルプの充実 | `--help` で全機能の使い方を表示 |
| NFR-U-002 | エラーメッセージ | ユーザーが理解しやすい日本語/英語メッセージ |
| NFR-U-003 | 初回起動 | インストール後、設定なしで即使用可能 |
| NFR-U-004 | コマンド補完 | シェル補完スクリプトの提供（bash/zsh/fish） |

### 4.5 保守性要件

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-M-001 | ログ出力 | エラー・警告をログファイルに記録 |
| NFR-M-002 | デバッグモード | `--verbose` フラグで詳細ログを出力 |
| NFR-M-003 | バージョン情報 | `--version` でバージョン・ビルド情報を表示 |
| NFR-M-004 | コードカバレッジ | 80%以上のテストカバレッジ |

### 4.6 セキュリティ要件

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-S-001 | 入力検証 | すべてのコマンドライン引数を検証 |
| NFR-S-002 | ファイルパーミッション | ログファイルは0600（所有者のみ読み書き可） |
| NFR-S-003 | 依存関係 | 脆弱性のある依存クレートを使用しない |
| NFR-S-004 | エラー情報 | エラーメッセージに機密情報を含めない |

---

## 5. 制約条件

### 5.1 技術的制約

| 制約 | 詳細 | 理由 |
|------|------|------|
| 言語 | Rust（2021 Edition以降） | ユーザー指定、パフォーマンス・安全性 |
| 最小Rustバージョン | 1.70以上 | 使用クレートの要件 |
| 依存クレート | 必要最小限に抑える | バイナリサイズ・ビルド時間の削減 |
| 非同期ランタイム | Tokio | エコシステムの成熟度 |
| 通知ライブラリ | mac-notification-sys または objc2 + UserNotifications | macOS専用、アクションボタン対応 |
| メニューバー | tray-icon または objc2 + AppKit | macOS専用、ネイティブUI |
| フォーカスモード | objc2 + Focus API | macOS 12以降のフォーカスモードAPI |
| サウンド | rodio または Core Audio | macOSネイティブサウンド再生 |
| macOS SDK | macOS 12 SDK以降 | フォーカスモードAPI使用のため |
| アーキテクチャ | クライアント・サーバーモデル | デーモン（常駐プロセス）+ CLI（クライアント） |
| IPC | Unix Domain Socket | ~/.pomodoro/pomodoro.sock で通信 |

### 5.2 ビジネス制約

| 制約 | 詳細 |
|------|------|
| 予算 | 個人開発（予算なし） |
| スケジュール | Phase 1: 2週間以内に完成 |
| リソース | 開発者1名（takemo101） |
| ライセンス | MIT/Apache-2.0デュアルライセンス |

### 5.3 法規制・コンプライアンス

| 要件 | 詳細 |
|------|------|
| オープンソースライセンス | 使用するすべてのクレートのライセンスを確認・遵守 |
| 依存クレートライセンス | MIT/Apache-2.0/BSD系のみ使用（GPL系は避ける） |

---

## 6. 外部インターフェース

### 6.1 外部システム連携

| システム名 | 連携内容 | 方式 | 頻度 |
|-----------|---------|------|------|
| macOS Notification Center | アクションボタン付き通知の表示 | UserNotifications framework | タイマー完了時 |
| macOSメニューバー | メニューバーアイコン表示とドロップダウンメニュー | AppKit framework | 常時 |
| macOSフォーカスモード | フォーカスモードの自動ON/OFF | Focus API | タイマー状態変更時 |
| LaunchAgent | バックグラウンドプロセス管理 | launchctl | ログイン時、常駐 |
| Core Audio | システムサウンド再生 | Core Audio framework | タイマー完了時 |
| ターミナル | 標準入出力 | ANSI制御シーケンス | リアルタイム |

### 6.2 データ永続化

Phase 1では永続化は実装しない。Phase 2で以下を検討：

| データ種別 | 保存先 | フォーマット |
|-----------|--------|-------------|
| タイマー状態 | `~/.pomodoro/state.json` | JSON |
| 統計データ | `~/.pomodoro/history.json` | JSON |
| 設定ファイル | `~/.pomodoro/config.toml` | TOML |
| ログファイル | `~/.pomodoro/logs/pomodoro.log` | TEXT |

---

## 7. 前提条件と依存関係

### 7.1 前提条件

- ユーザーはターミナルの基本操作ができる
- ユーザーのOSはmacOS 12 (Monterey) 以降
- ターミナルはANSIエスケープシーケンスに対応している（Terminal.app、iTerm2等）
- システム通知機能が有効になっている
- 通知許可がアプリケーションに付与されている
- フォーカスモード連携を使用する場合、フォーカスモードが設定されている
- LaunchAgent使用のため、ユーザーディレクトリへの書き込み権限がある

### 7.2 依存関係

| 依存先 | 内容 | 影響 |
|--------|------|------|
| Rust toolchain | ビルドに必要 | 開発環境必須 |
| Cargo | パッケージ管理・ビルド | 開発環境必須 |
| OS通知API | デスクトップ通知 | 通知機能に影響 |

---

## 8. リスクと課題

### 8.1 リスク一覧

| ID | リスク | 影響度 | 発生確率 | 対策 |
|----|--------|--------|---------|------|
| R-001 | macOS通知APIの実装が困難 | 高 | 中 | objc2のドキュメント・サンプルコード調査、段階的実装 |
| R-002 | ターミナルでANSI制御が効かない | 中 | 低 | シンプルなテキスト表示にフォールバック |
| R-003 | フォーカスモードAPIが非公開または制限あり | 高 | 中 | 代替手段（おやすみモード）の検討、ユーザーへの説明 |
| R-004 | LaunchAgentの権限問題 | 中 | 低 | インストール手順の明確化、エラーハンドリング強化 |
| R-005 | 依存クレートの脆弱性 | 中 | 低 | 定期的な `cargo audit` 実行 |
| R-006 | Apple Siliconでの動作問題 | 中 | 低 | M1/M2/M3 Macでの動作確認、ユニバーサルバイナリ作成 |
| R-007 | macOSバージョンアップでAPI変更 | 中 | 中 | 複数バージョンでのテスト、後方互換性の確保 |

### 8.2 未解決課題

| ID | 課題 | 担当 | 期限 |
|----|------|------|------|
| I-001 | LaunchAgentの実装方式とplist生成方法 | takemo101 | 2026-01-10 |
| I-002 | objc2を使用したUserNotifications APIの実装 | takemo101 | 2026-01-12 |
| I-003 | プログレスバーのちらつき防止方法 | takemo101 | 2026-01-08 |
| I-004 | シェル補完スクリプトの生成方法 | takemo101 | 2026-01-15 |
| I-005 | CI/CDパイプラインの構築（Intel/Apple Silicon両対応） | takemo101 | 2026-01-17 |
| I-006 | フォーカスモードAPIの調査と実装方法 | takemo101 | 2026-01-11 |
| I-007 | メニューバーアイコンの実装（tray-icon vs objc2） | takemo101 | 2026-01-09 |
| I-008 | 通知アクションボタンのイベントハンドリング | takemo101 | 2026-01-13 |

---

## 9. 用語集

| 用語 | 定義 |
|------|------|
| ポモドーロテクニック | 25分の作業と5分の休憩を繰り返す時間管理手法 |
| ポモドーロ | 1回の作業時間（デフォルト25分）の単位 |
| 短い休憩 | ポモドーロ間の5分間の休憩 |
| 長い休憩 | 4ポモドーロ完了後の15-30分の休憩 |
| サイクル | 作業→休憩の1セット |
| 自動サイクル | 休憩終了後に自動的に次の作業を開始する機能 |
| CLI | Command Line Interface（コマンドラインインターフェース） |
| システム通知 | OSのネイティブ通知機能（デスクトップ通知） |
| プログレスバー | 進捗を視覚的に示す棒グラフ |
| ANSI制御シーケンス | ターミナルの色・カーソル位置を制御する特殊文字列 |
| クレート | Rustのパッケージ（ライブラリ） |
| Tokio | Rustの非同期ランタイム |
| mac-notification-sys | RustのmacOS専用通知ライブラリ |
| objc2 | RustからObjective-C/Swiftのフレームワークを呼び出すライブラリ |
| UserNotifications | macOSの通知フレームワーク |
| AppKit | macOSのUIフレームワーク |
| Focus API | macOS 12以降のフォーカスモードAPI |
| LaunchAgent | macOSのバックグラウンドプロセス管理機構 |
| indicatif | Rustのプログレスバー・スピナーライブラリ |
| clap | Rustのコマンドライン引数パーサーライブラリ |
| rodio | Rustのクロスプラットフォームオーディオライブラリ |
| Core Audio | macOSのオーディオフレームワーク |

---

## 10. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0.0 | 2026-01-03 | 初版作成 | - |
| 2.0.0 | 2026-01-03 | macOS専用への変更、macOS固有機能追加（メニューバー、フォーカスモード、LaunchAgent等） | - |
| 2.1.0 | 2026-01-03 | IPC要件追加（Unix Domain Socket）、フォーカスモードAPIフォールバック追加、ログファイルパス追加、LaunchAgent未登録時の挙動追加 | - |

---

## 11. 技術スタック詳細

### 11.1 採用技術

| カテゴリ | 技術/ライブラリ | バージョン | 用途 |
|---------|---------------|-----------|------|
| 言語 | Rust | 1.70+ | 本体実装 |
| CLIパーサー | clap | 4.x | コマンドライン引数解析 |
| 通知 | mac-notification-sys または objc2 | 最新 | macOS Notification Center（アクションボタン対応） |
| メニューバー | tray-icon または objc2 + AppKit | 最新 | メニューバー常駐UI |
| フォーカスモード | objc2 | 最新 | macOSフォーカスモードAPI連携 |
| プログレスバー | indicatif | 0.17+ | 進捗表示 |
| 非同期ランタイム | tokio | 1.x | タイマー・非同期処理 |
| サウンド | rodio または Core Audio | 最新 | macOSネイティブサウンド再生 |
| IPC | interprocess または Unix Domain Socket | 最新 | デーモンとCLI間の通信 |
| シリアライズ | serde | 1.x | データ構造のシリアライズ（Phase 2） |
| JSON | serde_json | 1.x | JSON形式の読み書き（Phase 2） |
| TOML | toml | 0.8+ | LaunchAgent plist生成 |
| ロギング | tracing | 0.1+ | 構造化ログ |
| エラーハンドリング | anyhow | 1.x | エラー処理の簡略化 |

### 11.2 開発ツール

| ツール | 用途 |
|--------|------|
| rustfmt | コードフォーマット |
| clippy | 静的解析・リント |
| cargo-audit | 脆弱性チェック |
| cargo-deny | ライセンス・依存関係チェック |
| cargo-nextest | 高速テスト実行 |

---

## 12. スコープ外

以下の機能は本プロジェクトのスコープ外とし、Phase 2以降または別プロジェクトで検討します：

### Phase 2で検討する機能
- 統計・履歴記録機能（F-010）
- レポート出力機能（F-011）
- 設定ファイルによる永続化（F-012）
- 時間追加機能（F-013）
- カラー/スタイルカスタマイズ（F-014）
- ショートカットApp連携（F-022）
- Spotlight連携（F-023）

### Phase 3以降で検討する機能
- Web API連携（Toggl、RescueTime等）
- チーム機能（複数ユーザーでの統計共有）
- iOSアプリとの連携（iCloud同期）
- Apple Watch対応

### 明示的に含まないもの
- Windows/Linux対応（macOS専用）
- 完全なGUIアプリケーション（メニューバーUIのみ）
- Webアプリケーション
- ブラウザ拡張機能
- Androidアプリ
- リアルタイム同期機能
- クラウドストレージ連携
- ソーシャル機能（SNS投稿等）

---

## 付録A: コマンドリファレンス（Phase 1）

### 基本コマンド

```bash
# タイマー開始（デフォルト: 25分作業、5分休憩）
pomodoro start

# カスタム時間で開始
pomodoro start --work 30 --break 10 --long-break 20

# タスク名を設定して開始
pomodoro start --task "API実装"

# 自動サイクルで開始
pomodoro start --auto-cycle

# フォーカスモード連携を有効にして開始
pomodoro start --focus-mode

# 一時停止
pomodoro pause

# 再開
pomodoro resume

# 停止
pomodoro stop

# ステータス確認
pomodoro status

# LaunchAgentのインストール（ログイン時自動起動）
pomodoro install

# LaunchAgentのアンインストール
pomodoro uninstall

# デーモンモード起動（LaunchAgentから呼ばれる）
pomodoro daemon

# ヘルプ表示
pomodoro --help

# バージョン表示
pomodoro --version
```

### オプション一覧

| オプション | 短縮形 | 説明 | デフォルト値 |
|-----------|--------|------|-------------|
| `--work <分>` | `-w` | 作業時間（分） | 25 |
| `--break <分>` | `-b` | 短い休憩時間（分） | 5 |
| `--long-break <分>` | `-l` | 長い休憩時間（分） | 15 |
| `--task <名前>` | `-t` | タスク名 | なし |
| `--auto-cycle` | `-a` | 自動サイクル | false |
| `--focus-mode` | `-f` | フォーカスモード連携 | false |
| `--no-sound` | | 通知音を無効化 | false |
| `--verbose` | `-v` | 詳細ログ出力 | false |
| `--help` | `-h` | ヘルプ表示 | - |
| `--version` | `-V` | バージョン表示 | - |

---

## 付録B: エラーコード一覧

| コード | メッセージ | 原因 | 対処法 |
|--------|-----------|------|--------|
| E001 | タイマーは既に実行中です | 実行中に `start` を実行 | `stop` してから再度 `start` |
| E002 | タイマーは実行されていません | 未起動時に `pause`/`resume`/`stop` | `start` でタイマーを開始 |
| E003 | タイマーは一時停止していません | 非一時停止時に `resume` | `pause` してから `resume` |
| E004 | 無効な時間指定です | 範囲外の時間を指定 | 1-120分の範囲で指定 |
| E005 | 通知の送信に失敗しました | macOS通知APIエラー | システム通知設定を確認 |
| E006 | 無効なタスク名です | 空文字列または100文字超 | 1-100文字で指定 |
| E007 | 通知許可がありません | 通知許可が拒否されている | システム環境設定で通知を許可 |
| E008 | フォーカスモードが見つかりません | 指定したフォーカスモードが存在しない | システム環境設定でフォーカスモードを作成 |
| E009 | LaunchAgentのインストールに失敗しました | plistファイルの書き込みエラー | ディレクトリの書き込み権限を確認 |
| E010 | macOSバージョンが古すぎます | macOS 12未満 | macOS 12以降にアップグレード |

---

**要件定義書の作成完了**

このドキュメントは、プロジェクトの進行に伴い更新される可能性があります。変更がある場合は、変更履歴セクションに記録してください。
