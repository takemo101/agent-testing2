# {機能名} 外部API連携設計書

## 1. 連携先サービス概要

| サービス名 | 用途 | 公式ドキュメント |
|-----------|------|-----------------|
| Stripe | 決済処理 | https://stripe.com/docs/api |

## 2. 認証・認可

### 2.1 認証方式
| サービス | 方式 | 認証情報の保管場所 |
|---------|------|------------------|
| Stripe | API Key | 環境変数（STRIPE_SECRET_KEY） |

### 2.2 認証情報の管理
- 本番環境: AWS Secrets Manager
- 開発環境: .env.local（.gitignoreに追加）

## 3. API呼び出し仕様

### 3.1 エンドポイント一覧
| API | メソッド | パス | 用途 |
|-----|---------|------|------|
| 決済作成 | POST | /v1/payment_intents | 決済Intent作成 |

### 3.2 POST /v1/payment_intents

#### リクエスト
```json
{
  "amount": 1000,
  "currency": "jpy",
  "payment_method_types": ["card"]
}
```

#### レスポンス（成功）
```json
{
  "id": "pi_xxx",
  "client_secret": "pi_xxx_secret_xxx",
  "status": "requires_payment_method"
}
```

#### エラーレスポンス
| ステータス | エラーコード | 説明 | 対処 |
|-----------|------------|------|------|
| 400 | invalid_request_error | リクエスト不正 | パラメータ確認 |
| 401 | authentication_error | 認証エラー | API Key確認 |

## 4. リトライ戦略

| 条件 | リトライ回数 | 間隔 |
|------|:----------:|------|
| 5xx エラー | 3回 | 指数バックオフ（1s, 2s, 4s） |
| タイムアウト | 2回 | 1秒後 |
| 429 Rate Limit | 3回 | Retry-After ヘッダーに従う |

## 5. レート制限対策

| サービス | 制限 | 対策 |
|---------|------|------|
| Stripe | 100 req/s | キューイング、バッチ処理 |

## 6. テスト戦略

### 6.1 テスト環境
| 環境 | エンドポイント | 認証 |
|------|--------------|------|
| サンドボックス | api.stripe.com | テストAPIキー |

### 6.2 モック戦略
- 単体テスト: nock/msw でモック
- E2Eテスト: Stripeテストモード使用

## 7. 監視・アラート

| 監視項目 | 閾値 | アラート先 |
|---------|------|-----------|
| エラー率 | 5%超過 | Slack #alerts |
| レイテンシ | 3秒超過 | PagerDuty |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|:---|:---|:---|:---|
| YYYY-MM-DD | 1.0.0 | 初版作成 | - |
